name: Extension Checks

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  security-audit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Check for outdated packages
      run: npm outdated
      continue-on-error: true

  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting
      run: npx prettier --check "src/**/*.{ts,js,json,css,html}"

    - name: Build and check bundle size
      run: |
        npm run build
        echo "📦 Bundle size analysis:"
        du -sh dist/*

        # Check if bundle is reasonable size (under 5MB)
        BUNDLE_SIZE=$(du -s dist | cut -f1)
        if [ $BUNDLE_SIZE -gt 5120 ]; then
          echo "⚠️  Warning: Bundle size is larger than 5MB"
        else
          echo "✅ Bundle size is acceptable"
        fi

  extension-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build extension
      run: npm run build

    - name: Validate Chrome extension structure
      run: |
        echo "🔍 Validating Chrome extension structure..."

        # Check required files exist
        REQUIRED_FILES=("dist/manifest.json")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            exit 1
          fi
        done

        # Check manifest version
        MANIFEST_VERSION=$(jq -r '.manifest_version' dist/manifest.json)
        if [ "$MANIFEST_VERSION" != "3" ]; then
          echo "⚠️  Warning: Using Manifest V$MANIFEST_VERSION (V3 recommended)"
        fi

        # Check for required manifest fields
        REQUIRED_FIELDS=("name" "version" "description")
        for field in "${REQUIRED_FIELDS[@]}"; do
          if ! jq -e ".$field" dist/manifest.json > /dev/null; then
            echo "❌ Missing required manifest field: $field"
            exit 1
          fi
        done

        echo "✅ Chrome extension structure validation passed"